trigger:
  branches:
    include:
    - master

pool:
  vmImage: 'windows-2019'

variables:
  solution: 'xslt.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:
- task: UseDotNet@2
  displayName: 'Install .NET Core SDK'
  inputs:
    packageType: sdk
    useGlobalJson: true
- task: DotNetCoreCLI@2
  displayName: 'Restore'
  inputs:
    command: 'restore'
    projects: 'xslt.sln'
    feedsToUse: 'config'
    nugetConfigPath: './nuget.config'
- task: SonarCloudPrepare@1
  displayName: 'Sonarcloud - Prepare'
  inputs:
    SonarCloud: 'Sonarcloud - addupsolutions-oss'
    organization: 'addupsolutions-oss'
    scannerMode: 'MSBuild'
    projectKey: 'addup-xslt'
    projectName: 'addup-xslt'
    projectVersion: '1.0'
  continueOnError: true
- task: MSBuild@1
  displayName: 'Build Windows .NET 4.7.2'
  inputs:
    # Building a solution and not directly the csproj is required for Sonarcloud
    solution: './xslt-netfx.sln'
    msbuildArchitecture: 'x64'
    configuration: 'Release'    
    msbuildArguments: '/p:OutputPath=$(Build.ArtifactStagingDirectory)/net472/'
- task: SonarCloudAnalyze@1
  displayName: 'Sonarcloud - Analyze'
  continueOnError: true
- task: SonarCloudPublish@1
  displayName: 'Sonarcloud - Publish'
  inputs:
    pollingTimeoutSec: '300'      
  continueOnError: true
- task: DotNetCoreCLI@2
  displayName: 'Build Windows .NET Core'
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: './xslt/netcore/xslt-netcore.csproj'
    arguments: '-c $(buildConfiguration) -r win-x64 --output $(Build.ArtifactStagingDirectory)/win-x64/ /p:PublishSingleFile=true /p:PublishTrimmed=true'
    zipAfterPublish: false
- task: DotNetCoreCLI@2
  displayName: 'Build Linux .NET Core'
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: './xslt/netcore/xslt-netcore.csproj'
    arguments: '-c $(buildConfiguration) -r linux-x64 --output $(Build.ArtifactStagingDirectory)/linux-x64/ /p:PublishSingleFile=true /p:PublishTrimmed=true'        
    zipAfterPublish: false    
# - task: PowerShell@2
#   displayName: 'DEBUG #1'
#   inputs:
#     targetType: 'inline'
#     script: 'ls $(Build.ArtifactStagingDirectory) -recurse'
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/net472/xslt.exe'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/binaries/xslt-net472.zip'
    replaceExistingArchive: true
    verbose: true  
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/win-x64/netcore/xslt.exe'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/binaries/xslt-win.zip'
    replaceExistingArchive: true
    verbose: true      
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/linux-x64/netcore/xslt'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/binaries/xslt-linux.zip'
    replaceExistingArchive: true
    verbose: true          
# - task: PowerShell@2
#   displayName: 'DEBUG #2'
#   inputs:
#     targetType: 'inline'
#     script: 'ls $(Build.ArtifactStagingDirectory) -recurse'
- task: PublishBuildArtifacts@1
  displayName: Publish Packages as Build Artifacts
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)/binaries
    ArtifactName: addup-xslt-binaries
    publishLocation: Container